<!DOCTYPE html>

<html>
<head>
  <title>MongodbMixin.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="BatchMixin.html">
                BatchMixin.coffee
              </a>
            
              
              <a class="source" href="CsvWriterMixin.html">
                CsvWriterMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelReaderMixin.html">
                ExcelReaderMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelWriterMixin.html">
                ExcelWriterMixin.coffee
              </a>
            
              
              <a class="source" href="MergeMixin.html">
                MergeMixin.coffee
              </a>
            
              
              <a class="source" href="MongodbMixin.html">
                MongodbMixin.coffee
              </a>
            
              
              <a class="source" href="MysqlMixin.html">
                MysqlMixin.coffee
              </a>
            
              
              <a class="source" href="ObjectTransformMixin.html">
                ObjectTransformMixin.coffee
              </a>
            
              
              <a class="source" href="RestMixin.html">
                RestMixin.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>MongodbMixin.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Mongo mixin for datapumps</p>
<p>Usage:</p>
<ul>
<li><p>Load the mixin:</p>
<pre><code class="lang-coffee">{ <span class="hljs-attribute">mixin</span>: { MongodbMixin } } = <span class="hljs-built_in">require</span> <span class="hljs-string">'datapumps'</span>
</code></pre>
</li>
<li><p>Provide a db url or a db object to the mixin:</p>
<pre><code class="lang-coffee">pump
  .mixin MongodbMixin <span class="hljs-string">'mongodb://127.0.0.1:27017/test'</span> <span class="hljs-comment"># or mongodb.Db object</span>
</code></pre>
</li>
<li><p>Use <code>.useCollection()</code> to wrap mongodb.Collection methods into pump and write to mongo:</p>
<pre><code class="lang-coffee">pump
  .useCollection <span class="hljs-string">'products'</span>
  .process <span class="hljs-function"><span class="hljs-params">(product)</span> -&gt;</span>
    pump.insert { <span class="hljs-attribute">name</span>: product.name, <span class="hljs-attribute">code</span>: product.code }
</code></pre>
<p>Methods of the collection (like insert, update, remove, find) will be mixed into the pump</p>
<p>Note that the wrapped methods are promisified, so you cannot provide a callback.</p>
</li>
<li><p>Or read from mongo:</p>
<pre><code class="lang-coffee">pump
  .useCollection <span class="hljs-string">'posts'</span>
  .from pump.find(...)
</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>Promise = <span class="hljs-built_in">require</span> <span class="hljs-string">'bluebird'</span>
mongo = Promise.promisifyAll <span class="hljs-built_in">require</span> <span class="hljs-string">'mongodb'</span>
{ PassThrough } = <span class="hljs-built_in">require</span> <span class="hljs-string">'stream'</span>

<span class="hljs-built_in">module</span>.<span class="hljs-function"><span class="hljs-title">exports</span> = <span class="hljs-params">(db)</span> -&gt;</span>
  <span class="hljs-function"><span class="hljs-params">(target)</span> -&gt;</span>
    target._mongo =
      <span class="hljs-attribute">db</span>: db

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> db == <span class="hljs-string">'string'</span>
      (target._mongo.whenConnected = mongo.MongoClient.connectAsync db)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(db)</span> -&gt;</span>
          target._mongo.db = db
          target.whenFinished().<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span> target._mongo.db.close()
          <span class="hljs-keyword">if</span> target._mongo?.collection?._datapumpsMixinName?
            target._mongo.collection = db.collection target._mongo.collection._datapumpsMixinName

    _wrapMethod target, name <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> _wrappedMethods
    _wrapFind target

    target.<span class="hljs-function"><span class="hljs-title">db</span> = -&gt;</span>
      <span class="hljs-property">@_mongo</span>.db</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Use the given collection in the pump. The promisified methods of the collection will be proxied
from the pump, i.e. when you call .find() on the pump, it will call .find() on the collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    target.<span class="hljs-function"><span class="hljs-title">useCollection</span> = <span class="hljs-params">(name)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> target._mongo.whenConnected? <span class="hljs-keyword">and</span> target._mongo?.whenConnected.isPending()
        <span class="hljs-property">@_mongo</span>.collection =
          <span class="hljs-attribute">_datapumpsMixinName</span>: name
        _deferCollectionMethod <span class="hljs-property">@_mongo</span>.collection, name + <span class="hljs-string">'Async'</span>, @ <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> _wrappedMethods
        _deferFind <span class="hljs-property">@_mongo</span>.collection, @
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@_mongo</span>.collection = <span class="hljs-property">@_mongo</span>.db.collection name
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Returns a collection from the mongo database. Does not work until the connection established.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    target.<span class="hljs-function"><span class="hljs-title">collection</span> = <span class="hljs-params">(name)</span> -&gt;</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Not yet connected to mongo'</span>) <span class="hljs-keyword">if</span> target._mongo?.whenConnected.isPending()
      <span class="hljs-property">@_mongo</span>.db.collection name

_wrappedMethods = [ <span class="hljs-string">'insert'</span>, <span class="hljs-string">'remove'</span>, <span class="hljs-string">'rename'</span>, <span class="hljs-string">'save'</span>, <span class="hljs-string">'update'</span>, <span class="hljs-string">'count'</span>, <span class="hljs-string">'drop'</span>, <span class="hljs-string">'findOne'</span>,
  <span class="hljs-string">'createIndex'</span>, <span class="hljs-string">'ensureIndex'</span>, <span class="hljs-string">'dropIndex'</span>, <span class="hljs-string">'reIndex'</span>, <span class="hljs-string">'group'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'indexes'</span>, <span class="hljs-string">'stats'</span>,
  <span class="hljs-string">'findAndModify'</span>, <span class="hljs-string">'findAndRemove'</span> ]

<span class="hljs-function"><span class="hljs-title">_wrapMethod</span> = <span class="hljs-params">(target, name)</span> -&gt;</span>
  target[name] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Collection is not set. Use .useCollection before using this wrapper'</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@_mongo</span>.collection?
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Method .<span class="hljs-subst">#{name}</span>Async() does not exist in collection."</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@_mongo</span>.collection[name + <span class="hljs-string">'Async'</span>]
    <span class="hljs-property">@_mongo</span>.collection[name + <span class="hljs-string">'Async'</span>].apply(<span class="hljs-property">@_mongo</span>.collection, args)

<span class="hljs-function"><span class="hljs-title">_wrapFind</span> = <span class="hljs-params">(target)</span> -&gt;</span>
  target.<span class="hljs-function"><span class="hljs-title">find</span> = <span class="hljs-params">(args...)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Collection is not set. Use .useCollection before using this wrapper'</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@_mongo</span>.collection?
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Method .find() does not exist in collection."</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@_mongo</span>.collection.find
    <span class="hljs-property">@_mongo</span>.collection.find.apply(<span class="hljs-property">@_mongo</span>.collection, args).stream()

<span class="hljs-function"><span class="hljs-title">_deferCollectionMethod</span> = <span class="hljs-params">(collection, name, target)</span> -&gt;</span>
  collection[name] = <span class="hljs-function"><span class="hljs-params">(args...)</span>-&gt;</span>
    target._mongo.whenConnected.<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Method .<span class="hljs-subst">#{name}</span> does not exist in collection."</span> <span class="hljs-keyword">if</span> !target._mongo.collection[name]
      target._mongo.collection[name].apply(target._mongo.collection, args)

<span class="hljs-function"><span class="hljs-title">_deferFind</span> = <span class="hljs-params">(collection, target)</span> -&gt;</span>
  collection.<span class="hljs-function"><span class="hljs-title">find</span> = <span class="hljs-params">(args...)</span> -&gt;</span>
    result = <span class="hljs-keyword">new</span> PassThrough
      <span class="hljs-attribute">objectMode</span>: <span class="hljs-literal">true</span>
      <span class="hljs-attribute">highWaterMark</span>: <span class="hljs-number">10</span>

    target._mongo.whenConnected.<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span>
      target._mongo.collection.find.apply(target._mongo.collection, args).stream().pipe result

    { <span class="hljs-attribute">stream</span>:<span class="hljs-function"> -&gt;</span> result }</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
